---
import Layout from '../layouts/Layout.astro';
import flashcardsSrc from '../data/flashcards.json';
import { marked } from 'marked';
import createDOMPurify from 'dompurify';
import { JSDOM } from 'jsdom';

marked.setOptions({
  mangle: false,
  headerIds: false,
});

// Read the JSON at build time and render answers to sanitized HTML.
const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);

    const cardsSource = Array.isArray(flashcardsSrc) ? flashcardsSrc : [];
const processed = cardsSource.map((c) => {
  const qRaw = (c.q || '').toString();
  const qLines = qRaw.split('\n').map((line) => line.trim()).filter(Boolean);
  const title = qLines[0] || 'Untitled';
  const authorLine = qLines[1] || '';
  const author = authorLine.replace(/^by\s+/i, '').trim();

  const aRaw = (c.a || '').toString();
  const listItems = aRaw
    .split('\n')
    .map((line) => line.trim())
    .filter((line) => line.startsWith('- '))
    .map((line) => line.replace(/^- /, '').trim())
    .filter(Boolean);
  const fallbackItems = aRaw
    .split('\n')
    .map((line) => line.trim())
    .filter(Boolean)
    .map((line) => line.replace(/^- /, '').trim())
    .filter(Boolean);
  const ideas = (listItems.length ? listItems : fallbackItems).slice(0, 2);
  const ideasMarkdown = ideas.map((idea) => `- ${idea}`).join('\n');

  let ideasHtml = '';
  try {
    ideasHtml = DOMPurify.sanitize(marked.parse(ideasMarkdown));
  } catch (err) {
    ideasHtml = ideas.map((idea) => `<li>${idea}</li>`).join('');
    ideasHtml = `<ul>${ideasHtml}</ul>`;
  }

  return { ...c, title, author, ideasHtml, q: qRaw, a: aRaw };
});

const cardsJson = JSON.stringify(processed).replace(/</g, '\\u003C');
---

<Layout>

  <style>
    :root {
      --card-w: min(720px, 92vw);
      --radius: 14px;
      --card-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      --focus: hsl(212 90% 56%);
    }

    main.deck { min-height: 70vh; display:grid; place-items:center; padding: clamp(16px,3vw,48px); gap:18px }
    .stack { display: grid; gap: 18px; width: var(--card-w); }

    .card {
      width: 100%;
      background: var(--background-color);
      color: var(--text-color);
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: var(--card-shadow);
      padding: clamp(1.25rem, 3vw, 2rem);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card__eyebrow {
      font-size: 0.8rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(15, 23, 42, 0.6);
    }

    .card__front,
    .card__back {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
      text-align: center;
    }

    .card__front.is-hidden,
    .card__back.is-hidden {
      display: none;
    }

    .card__title {
      font-size: clamp(1.3rem, 1.1rem + 1vw, 1.8rem);
      font-weight: 700;
      line-height: 1.4;
    }

    .card__author {
      font-size: 1rem;
      color: var(--muted-text);
    }

    .card__back-title {
      font-size: 1.1rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted-text);
    }

    .card__ideas {
      width: 100%;
      text-align: left;
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      padding-top: 0.75rem;
      line-height: 1.6;
      font-size: 1rem;
      color: #334155;
    }

    .card__image {
      max-width: min(320px, 80%);
      border-radius: 10px;
      align-self: center;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.15);
    }

    :root[data-theme='dark'] .card__ideas {
      color: var(--text-color);
      border-top-color: rgba(148, 163, 184, 0.25);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .controls button {
      background: rgba(15, 23, 42, 0.05);
      border: 1px solid rgba(15, 23, 42, 0.12);
      color: var(--text-color);
      padding: .45rem .9rem;
      border-radius: 999px;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }

    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .controls button:hover:not(:disabled),
    .controls button:focus-visible {
      background: rgba(15, 23, 42, 0.12);
      outline: none;
      transform: translateY(-1px);
    }

    .card__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: rgba(15, 23, 42, 0.7);
    }

    .progress {
      min-width: 4rem;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .hint {
      text-align: center;
      font-size: 0.85rem;
      color: rgba(15, 23, 42, 0.65);
      max-width: var(--card-w);
    }

    .issue-link {
      align-self: center;
      font-size: 0.9rem;
      color: var(--link-color);
      text-decoration: none;
      margin-top: 0.25rem;
    }

    .issue-link:hover,
    .issue-link:focus-visible {
      text-decoration: underline;
    }
  </style>

  <main class="deck">
    <h1>Flashcards</h1>

    <section class="stack" aria-label="Flashcard viewer">
      <article class="card" aria-live="polite">
        <div class="card__meta">
          <span class="card__eyebrow" id="eyebrow">Front</span>
          <span class="progress" id="progress">1 / —</span>
        </div>
        <div class="card__front" id="cardFront">
          <img id="cardImage" src="" alt="" loading="lazy" decoding="async" width="320" height="240" class="card__image" hidden />
          <div class="card__title" id="cardTitle">{processed[0] ? processed[0].title : 'Loading…'}</div>
          <div class="card__author" id="cardAuthor">{processed[0]?.author ? `by ${processed[0].author}` : ''}</div>
        </div>
        <div class="card__back is-hidden" id="cardBack">
          <h2 class="card__back-title">Two Major Ideas</h2>
          <div class="card__ideas" id="cardIdeas" set:html={processed[0] ? processed[0].ideasHtml : ''}></div>
        </div>
        <button id="toggleBtn" type="button">Show ideas</button>
        <a id="issueLink" class="issue-link" href="#" target="_blank" rel="noreferrer noopener" hidden>Suggest an edit on GitHub</a>
      </article>

      <div class="controls">
        <button id="prevBtn" aria-label="Previous card">← Prev</button>
        <button id="nextBtn" aria-label="Next card">Next →</button>
      </div>
    </section>

    <p class="hint">Tip: Press the “Show ideas” button or hit <kbd>Space</kbd>/<kbd>Enter</kbd> when focused. Use <kbd>←</kbd>/<kbd>→</kbd> to move between cards.</p>
  </main>

  <!-- serialized processed data for client -->
  <script id="flashcards-data" type="application/json" set:html={cardsJson}></script>

  <script>
  (function () {
    if (typeof window === 'undefined') return;
    if (window.__pbvFlashcardsInitialized) return;
    window.__pbvFlashcardsInitialized = true;

    const dataEl = document.getElementById('flashcards-data');
    let cards = [];
    try {
      const json = dataEl ? (dataEl.textContent || '').trim() : '';
      cards = json ? JSON.parse(json) : [];
    } catch (err) {
      console.error('Failed to parse flashcards data', err);
      cards = [];
    }

    let idx = 0;
    let showAnswer = false;

    const cardFront = document.getElementById('cardFront');
    const cardBack = document.getElementById('cardBack');
    const titleEl = document.getElementById('cardTitle');
    const authorEl = document.getElementById('cardAuthor');
    const ideasEl = document.getElementById('cardIdeas');
    const eyebrowEl = document.getElementById('eyebrow');
    const progressEl = document.getElementById('progress');
    const toggleBtn = document.getElementById('toggleBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const imageEl = document.getElementById('cardImage');
    const issueLink = document.getElementById('issueLink');
    const ISSUE_BASE = 'https://github.com/Enki--/pbvinge.com/issues/new';

    function updateAnswerVisibility() {
      if (!cardFront || !cardBack || !toggleBtn) return;
      cardFront.classList.toggle('is-hidden', showAnswer);
      cardBack.classList.toggle('is-hidden', !showAnswer);
      toggleBtn.textContent = showAnswer ? 'Show cover' : 'Show ideas';
      eyebrowEl && (eyebrowEl.textContent = showAnswer ? 'Back' : 'Front');
    }

    function stripHtml(input = '') {
      return input.replace(/<[^>]+>/g, '').replace(/\\s+/g, ' ').trim();
    }

    function updateIssueLink(card) {
      if (!issueLink) return;
      if (!card) {
        issueLink.hidden = true;
        issueLink.removeAttribute('href');
        return;
      }
      const titleLine = card.title || (card.q || '').split('\\n')[0] || 'Flashcard';
      const answerText = card.ideasHtml ? stripHtml(card.ideasHtml) : (card.a || '');
      const params = new URLSearchParams({
        title: `Flashcard feedback: ${titleLine}`.slice(0, 256),
        body: `Flashcard front:\\n${card.title || card.q || ''}${card.author ? `\\nby ${card.author}` : ''}\\n\\nCurrent ideas:\\n${answerText || '(empty)'}\\n\\nCard index: ${idx + 1} of ${cards.length}`
      });
      issueLink.href = `${ISSUE_BASE}?${params.toString()}`;
      issueLink.hidden = false;
    }

    function render() {
      const hasCards = cards.length > 0;
      const controls = [toggleBtn, prevBtn, nextBtn];
      controls.forEach(btn => btn && (btn.disabled = !hasCards));

      if (!hasCards) {
        titleEl && (titleEl.textContent = 'No cards available');
        authorEl && (authorEl.textContent = '');
        ideasEl && (ideasEl.textContent = '');
        eyebrowEl && (eyebrowEl.textContent = 'Front');
        progressEl && (progressEl.textContent = '0 / 0');
        if (imageEl) {
          imageEl.hidden = true;
          imageEl.removeAttribute('src');
          imageEl.alt = '';
        }
        showAnswer = false;
        updateAnswerVisibility();
        updateIssueLink(null);
        return;
      }

      idx = ((idx % cards.length) + cards.length) % cards.length;
      const current = cards[idx];

      titleEl && (titleEl.textContent = current.title || '');
      authorEl && (authorEl.textContent = current.author ? `by ${current.author}` : '');
      if (ideasEl) {
        ideasEl.innerHTML = current.ideasHtml || '';
      }

      eyebrowEl && (eyebrowEl.textContent = showAnswer ? 'Back' : 'Front');
      progressEl && (progressEl.textContent = `${idx + 1} / ${cards.length}`);

      if (imageEl) {
        if (current.img) {
          let imgUrl = current.img;
          if (imgUrl.startsWith('http://')) {
            imgUrl = imgUrl.replace(/^http:\/\//, 'https://');
          }
          imageEl.src = imgUrl;
          imageEl.alt = current.q || 'Flashcard image';
          imageEl.hidden = false;
        } else {
          imageEl.hidden = true;
          imageEl.removeAttribute('src');
          imageEl.alt = '';
        }
      }

      updateAnswerVisibility();
      updateIssueLink(current);
    }

    function changeCard(delta) {
      if (!cards.length) return;
      idx = (idx + delta + cards.length) % cards.length;
      showAnswer = false;
      render();
      toggleBtn && toggleBtn.focus();
    }

    toggleBtn && toggleBtn.addEventListener('click', () => {
      if (!cards.length) return;
      showAnswer = !showAnswer;
      updateAnswerVisibility();
    });

    prevBtn && prevBtn.addEventListener('click', () => changeCard(-1));
    nextBtn && nextBtn.addEventListener('click', () => changeCard(1));

    document.addEventListener('keydown', (e) => {
      if (!cards.length) return;
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        changeCard(1);
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        changeCard(-1);
      } else if (e.key === ' ' || e.key === 'Spacebar' || e.code === 'Space') {
        if (document.activeElement && document.activeElement.closest('.card')) {
          e.preventDefault();
          showAnswer = !showAnswer;
          updateAnswerVisibility();
        }
      }
    });

    render();
  })();
  </script>
</Layout>
