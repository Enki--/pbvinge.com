---
import Layout from '../layouts/Layout.astro';
import flashcardsSrc from '../data/flashcards.json';
import { marked } from 'marked';
import createDOMPurify from 'dompurify';
import { JSDOM } from 'jsdom';

// Read the JSON at build time and render answers to sanitized HTML.
const window = new JSDOM('').window;
const DOMPurify = createDOMPurify(window);

const cardsSource = Array.isArray(flashcardsSrc) ? flashcardsSrc : [];
const processed = cardsSource.map((c) => {
  const aRaw = c.a || '';
  let aHtml = '';
  try {
    aHtml = DOMPurify.sanitize(marked.parse(aRaw));
  } catch (err) {
    aHtml = aRaw;
  }
  return { ...c, aHtml };
});

const cardsJson = JSON.stringify(processed).replace(/</g, '\\u003C');
---

<Layout>

  <style>
    :root {
      --card-w: min(720px, 92vw);
      --radius: 14px;
      --card-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      --focus: hsl(212 90% 56%);
    }

    main.deck { min-height: 70vh; display:grid; place-items:center; padding: clamp(16px,3vw,48px); gap:18px }
    .stack { display: grid; gap: 18px; width: var(--card-w); }

    .card {
      width: 100%;
      background: var(--background-color);
      color: var(--text-color);
      border-radius: var(--radius);
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: var(--card-shadow);
      padding: clamp(1.25rem, 3vw, 2rem);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card__eyebrow {
      font-size: 0.8rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: rgba(15, 23, 42, 0.6);
    }

    .card__question {
      font-size: clamp(1.2rem, 1rem + 1vw, 1.6rem);
      font-weight: 600;
      line-height: 1.5;
      text-align: center;
      white-space: pre-line;
    }

    .card__answer {
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      padding-top: 0.75rem;
      line-height: 1.55;
      font-size: 1rem;
      color: #334155;
    }

    .card__answer.is-hidden {
      display: none;
    }

    .card__image {
      max-width: min(320px, 80%);
      border-radius: 10px;
      align-self: center;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.15);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      width: 100%;
    }

    .controls button {
      background: rgba(15, 23, 42, 0.05);
      border: 1px solid rgba(15, 23, 42, 0.12);
      color: var(--text-color);
      padding: .45rem .9rem;
      border-radius: 999px;
      cursor: pointer;
      transition: background .2s ease, transform .2s ease;
    }

    .controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .controls button:hover:not(:disabled),
    .controls button:focus-visible {
      background: rgba(15, 23, 42, 0.12);
      outline: none;
      transform: translateY(-1px);
    }

    .card__meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: rgba(15, 23, 42, 0.7);
    }

    .progress {
      min-width: 4rem;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }

    .hint {
      text-align: center;
      font-size: 0.85rem;
      color: rgba(15, 23, 42, 0.65);
      max-width: var(--card-w);
    }
  </style>

  <main class="deck">
    <h1>Flashcards</h1>

    <section class="stack" aria-label="Flashcard viewer">
      <article class="card" aria-live="polite">
        <div class="card__meta">
          <span class="card__eyebrow" id="eyebrow">Question</span>
          <span class="progress" id="progress">1 / —</span>
        </div>
        <div class="card__question" id="q-current">{processed[0] ? processed[0].q : 'Loading…'}</div>
        <img id="cardImage" src="" alt="" loading="lazy" decoding="async" width="320" height="240" class="card__image" hidden />
        <div class="card__answer is-hidden" id="a-current-content" set:html={processed[0] ? processed[0].aHtml : ''}></div>
        <button id="toggleBtn" type="button">Show answer</button>
      </article>

      <div class="controls">
        <button id="prevBtn" aria-label="Previous card">← Prev</button>
        <button id="nextBtn" aria-label="Next card">Next →</button>
      </div>
    </section>

    <p class="hint">Tip: Press the “Show answer” button or hit <kbd>Space</kbd>/<kbd>Enter</kbd> when focused. Use <kbd>←</kbd>/<kbd>→</kbd> to move between cards.</p>
  </main>

  <!-- serialized processed data for client -->
  <script id="flashcards-data" type="application/json" set:html={cardsJson}></script>

  <script>
  (function () {
    if (typeof window === 'undefined') return;
    if (window.__pbvFlashcardsInitialized) return;
    window.__pbvFlashcardsInitialized = true;

    const dataEl = document.getElementById('flashcards-data');
    let cards = [];
    try {
      const json = dataEl ? (dataEl.textContent || '').trim() : '';
      cards = json ? JSON.parse(json) : [];
    } catch (err) {
      console.error('Failed to parse flashcards data', err);
      cards = [];
    }

    let idx = 0;
    let showAnswer = false;

    const questionEl = document.getElementById('q-current');
    const answerEl = document.getElementById('a-current-content');
    const eyebrowEl = document.getElementById('eyebrow');
    const progressEl = document.getElementById('progress');
    const toggleBtn = document.getElementById('toggleBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const imageEl = document.getElementById('cardImage');

    function updateAnswerVisibility() {
      if (!answerEl || !toggleBtn) return;
      answerEl.classList.toggle('is-hidden', !showAnswer);
      toggleBtn.textContent = showAnswer ? 'Hide answer' : 'Show answer';
    }

    function render() {
      const hasCards = cards.length > 0;
      const controls = [toggleBtn, prevBtn, nextBtn];
      controls.forEach(btn => btn && (btn.disabled = !hasCards));

      if (!hasCards) {
        questionEl && (questionEl.textContent = 'No cards available');
        answerEl && (answerEl.textContent = '');
        eyebrowEl && (eyebrowEl.textContent = 'Question');
        progressEl && (progressEl.textContent = '0 / 0');
        if (imageEl) {
          imageEl.hidden = true;
          imageEl.removeAttribute('src');
          imageEl.alt = '';
        }
        showAnswer = false;
        updateAnswerVisibility();
        return;
      }

      idx = ((idx % cards.length) + cards.length) % cards.length;
      const current = cards[idx];

      questionEl && (questionEl.textContent = current.q || '');
      if (answerEl) {
        if (current.aHtml) {
          answerEl.innerHTML = current.aHtml;
        } else {
          answerEl.textContent = current.a || '';
        }
      }

      eyebrowEl && (eyebrowEl.textContent = `Question ${idx + 1}`);
      progressEl && (progressEl.textContent = `${idx + 1} / ${cards.length}`);

      if (imageEl) {
        if (current.img) {
          let imgUrl = current.img;
          if (imgUrl.startsWith('http://')) {
            imgUrl = imgUrl.replace(/^http:\/\//, 'https://');
          }
          imageEl.src = imgUrl;
          imageEl.alt = current.q || 'Flashcard image';
          imageEl.hidden = false;
        } else {
          imageEl.hidden = true;
          imageEl.removeAttribute('src');
          imageEl.alt = '';
        }
      }

      updateAnswerVisibility();
    }

    function changeCard(delta) {
      if (!cards.length) return;
      idx = (idx + delta + cards.length) % cards.length;
      showAnswer = false;
      render();
      toggleBtn && toggleBtn.focus();
    }

    toggleBtn && toggleBtn.addEventListener('click', () => {
      if (!cards.length) return;
      showAnswer = !showAnswer;
      updateAnswerVisibility();
    });

    prevBtn && prevBtn.addEventListener('click', () => changeCard(-1));
    nextBtn && nextBtn.addEventListener('click', () => changeCard(1));

    document.addEventListener('keydown', (e) => {
      if (!cards.length) return;
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        changeCard(1);
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        changeCard(-1);
      } else if (e.key === ' ' || e.key === 'Spacebar' || e.code === 'Space') {
        if (document.activeElement && document.activeElement.closest('.card')) {
          e.preventDefault();
          showAnswer = !showAnswer;
          updateAnswerVisibility();
        }
      }
    });

    render();
  })();
  </script>
</Layout>
