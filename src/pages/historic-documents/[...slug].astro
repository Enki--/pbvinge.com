---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const docs = await getCollection('documents', ({ data }) => data.isPublished !== false);
  return docs.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

function fmtDate(d?: string | Date) {
  if (!d) return '';
  const date = new Date(d);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}
---

<Layout title={`${entry.data.title} - Historic Document`}>
  <article class="doc">
    <header class="header">
      <h1>{entry.data.title}</h1>
      {entry.data.subtitle && <p class="subtitle">{entry.data.subtitle}</p>}
      <div class="meta">
        {entry.data.authors && entry.data.authors.length > 0 && (
          <span class="author">{entry.data.authors.join(', ')}</span>
        )}
        {entry.data.origin && <span class="origin">{entry.data.origin}</span>}
        {entry.data.date && <span class="date">{fmtDate(entry.data.date)}</span>}
      </div>
      {entry.data.externalUrl && (
        <p class="external">
          <a class="button" href={entry.data.externalUrl} target="_blank" rel="noopener noreferrer">View Original â†’</a>
        </p>
      )}
    </header>

    <div class="content prose">
      <Content />
    </div>

    {entry.data.tags && entry.data.tags.length > 0 && (
      <footer class="footer">
        <div class="tags">
          {entry.data.tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      </footer>
    )}
  </article>
</Layout>

<style>
  .doc { max-width: 880px; margin: 0 auto; padding: 2rem 1rem; }
  .header { text-align: center; margin-bottom: 2rem; }
  h1 { font-size: 2.25rem; margin: 0; }
  .subtitle { font-size: 1.2rem; color: #666; margin-top: 0.25rem; }
  .meta { display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center; margin-top: 0.75rem; color: #666; }
  .external { margin-top: 1rem; }
  .button { display: inline-block; background: #2563eb; color: #fff; padding: 0.5rem 0.9rem; border-radius: 8px; text-decoration: none; font-size: 0.95rem; }
  .button:hover { background: #1e40af; }
  .content { font-size: 1.05rem; line-height: 1.8; color: #222; max-width: 46rem; margin: 0 auto; text-align: left; word-break: break-word; }
  .content :global(hr) { margin: 2rem 0; border: none; border-top: 1px solid #e5e5e5; }
  .content :global(h2),
  .content :global(h3) { margin: 2.25rem 0 1rem; }
  .content :global(p) { margin: 1rem 0; }
  .content :global(ul),
  .content :global(ol) { margin: 1rem 0 1rem 1.25rem; }
  .content :global(li) { margin: 0.35rem 0; }
  .content :global(blockquote) { margin: 1.5rem 0; padding: 0.75rem 1rem; border-left: 4px solid #e5e5e5; background: #fafafa; }
  .content :global(img) { max-width: 100%; height: auto; display: block; margin: 1.25rem auto; border-radius: 6px; }
  .content :global(pre) { overflow-x: auto; padding: 1rem; background: #0b1020; color: #e5e7eb; border-radius: 8px; font-size: 0.95rem; }
  .content :global(code) { background: #f4f4f5; padding: 0.1rem 0.3rem; border-radius: 4px; }
  .content :global(table) { display: block; width: 100%; overflow-x: auto; border-collapse: collapse; border-spacing: 0; }
  .content :global(th),
  .content :global(td) { border-bottom: 1px solid #eee; padding: 0.5rem 0.75rem; text-align: left; white-space: nowrap; }
  .content :global(tr:nth-child(even)) { background: #fafafa; }
  .page-marker { display: block; margin: 2rem auto 0.5rem; font-weight: 600; color: #444; }
  .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; }
  .tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .tag { background: #f0f0f0; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.85rem; color: #555; }

  :root[data-theme='dark'] .subtitle,
  :root[data-theme='dark'] .meta { color: var(--muted-text); }
  :root[data-theme='dark'] .content { color: var(--text-color); }
  :root[data-theme='dark'] .content :global(hr) { border-top-color: #1f2a44; }
  :root[data-theme='dark'] .content :global(blockquote) { border-left-color: #1f2a44; background: #0f172a; }
  :root[data-theme='dark'] .content :global(code) { background: #0f172a; color: var(--text-color); }
  :root[data-theme='dark'] .content :global(th),
  :root[data-theme='dark'] .content :global(td) { border-bottom-color: #1f2a44; }
  :root[data-theme='dark'] .content :global(tr:nth-child(even)) { background: #0b1220; }
  :root[data-theme='dark'] .page-marker { color: var(--muted-text); }
  :root[data-theme='dark'] .footer { border-top-color: #1f2a44; }
  :root[data-theme='dark'] .tag { background: rgba(148, 163, 184, 0.2); color: var(--muted-text); }

  /* Mobile tweaks */
  @media (max-width: 640px) {
    .doc { padding: 1.25rem 1rem; }
    h1 { font-size: 1.75rem; }
    .subtitle { font-size: 1.05rem; }
    .content { font-size: 1rem; }
    .content :global(h2) { font-size: 1.25rem; }
    .content :global(h3) { font-size: 1.1rem; }
    .content :global(pre) { font-size: 0.9rem; }
  }
</style>

<script>
  // Enhance readability: mark "Page N" lines so we can add spacing
  const content = document.querySelector('.content');
  if (content) {
    const ps = content.querySelectorAll('p');
    const re = /^Page\s+(?:[IVXLCDM]+-\d+|\d+)(?:\.)?$/;
    ps.forEach(p => {
      const t = (p.textContent || '').trim();
      if (re.test(t)) p.classList.add('page-marker');
    });
  }
  </script>
